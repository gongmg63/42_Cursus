input {
  beats {
    port => 5044
    ssl_enabled => true
    ssl_certificate => "/usr/share/logstash/certs/logstash/logstash.crt"
    ssl_key => "/usr/share/logstash/certs/logstash/logstash.key"
  }
}

filter {
	grok{
		match => { 
			"message" => "%{IPORHOST:remoteAddr} (?:-|(%{WORD}.%{WORD})) %{USER:ident} \[%{HTTPDATE:timestamp}\] \"(?:%{WORD:method} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})\" %{NUMBER:status} (?:%{NUMBER:bytes}|-) %{QS:referrer} %{QS:agent} %{QS:forwarder}" 
		}
	}
	date{
		match => [ "nginx.timestamp", "dd/MMM/yyyy:HH:mm:ss +0900" ]
		timezone => "Asia/Seoul"
		target => "@timestamp"
	}
	mutate{
		remove_field => [ "message" ]
	}
}

output {
  elasticsearch {
    index => "logstash-%{+YYYY.MM.dd}"
    hosts=> "${ELASTIC_HOSTS}"
    user=> "${ELASTIC_USER}"
    password=> "${ELASTIC_PASSWORD}"
    ssl_enabled=> true
    ssl_certificate_authorities => "/usr/share/logstash/certs/ca/ca.crt"
  }
}
